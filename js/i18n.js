/**
 * IAFEI Internationalization (i18n) Manager
 * Â§öËØ≠Ë®ÄÂõΩÈôÖÂåñÁÆ°ÁêÜÁ≥ªÁªü
 */
class I18nManager {
    constructor() {
        this.currentLanguage = 'en'; // ÈªòËÆ§ËØ≠Ë®Ä
        this.translations = {};
        this.supportedLanguages = {
            'en': 'English',
            'zh-cn': 'ÁÆÄ‰Ωì‰∏≠Êñá',
            'zh-tw': 'ÁπÅÈ´î‰∏≠Êñá',
            'ja': 'Êó•Êú¨Ë™û',
            'de': 'Deutsch',
            'it': 'Italiano'
        };
        this.fallbackLang = 'en';
        this.isLoading = false;
    }

    /**
     * ÂàùÂßãÂåñÂõΩÈôÖÂåñÁ≥ªÁªü
     */
    async init() {
        try {
            console.log('üöÄ Starting i18n initialization...');
            
            // Ê£ÄÊµãÁî®Êà∑È¶ñÈÄâËØ≠Ë®Ä
            this.currentLanguage = this.detectLanguage();
            console.log(`üîç Detected language: ${this.currentLanguage}`);
            
            // Âä†ËΩΩÁøªËØëÊñá‰ª∂
            await this.loadTranslations(this.currentLanguage);
            console.log(`üìÑ Translations loaded for: ${this.currentLanguage}`);
            
            // Â∫îÁî®ÁøªËØë
            this.applyTranslations();
            console.log('üé® Translations applied to DOM');
            
            // Êõ¥Êñ∞HTMLËØ≠Ë®ÄÂ±ûÊÄß
            this.updateHtmlLang();
            console.log('üîó HTML lang attribute updated');
            
            // ÂàùÂßãÂåñËØ≠Ë®ÄÂàáÊç¢Âô®
            this.initLanguageSelector();
            console.log('üéõÔ∏è Language selector initialized');
            
            console.log(`‚úÖ i18n initialized successfully with language: ${this.currentLanguage}`);
            
            // Ê∑ªÂä†Ë∞ÉËØï‰ø°ÊÅØÂà∞ÊéßÂà∂Âè∞
            this.debugInfo();
            
        } catch (error) {
            console.error('‚ùå i18n initialization failed:', error);
            console.error('Stack trace:', error.stack);
            
            // ‰ΩøÁî®ÈªòËÆ§ËØ≠Ë®Ä‰Ωú‰∏∫ÂêéÂ§á
            if (this.currentLanguage !== this.fallbackLang) {
                console.log(`üîÑ Falling back to default language: ${this.fallbackLang}`);
                await this.switchLanguage(this.fallbackLang);
            }
        }
    }

    /**
     * Ë∞ÉËØï‰ø°ÊÅØ
     */
    debugInfo() {
        console.log('üêõ I18n Debug Info:', {
            currentLanguage: this.currentLanguage,
            supportedLanguages: Object.keys(this.supportedLanguages),
            translationsLoaded: !!this.translations,
            languageBtn: !!document.getElementById('languageBtn'),
            languageDropdown: !!document.getElementById('languageDropdown'),
            languageOptions: document.querySelectorAll('.language-option').length
        });
    }

    /**
     * Ê£ÄÊµãÁî®Êà∑È¶ñÈÄâËØ≠Ë®Ä
     */
    detectLanguage() {
        // ‰ºòÂÖàÁ∫ßÔºöURLÂèÇÊï∞ > localStorage > ÊµèËßàÂô®ËØ≠Ë®Ä > ÈªòËÆ§ËØ≠Ë®Ä
        
        // 1. Ê£ÄÊü•URLÂèÇÊï∞
        const urlParams = new URLSearchParams(window.location.search);
        const urlLang = urlParams.get('lang');
        if (urlLang && this.supportedLanguages[urlLang]) {
            return urlLang;
        }

        // 2. Ê£ÄÊü•localStorage
        const storedLang = localStorage.getItem('iafei-language');
        if (storedLang && this.supportedLanguages[storedLang]) {
            return storedLang;
        }

        // 3. Ê£ÄÊü•ÊµèËßàÂô®ËØ≠Ë®Ä
        const browserLang = navigator.language.toLowerCase();
        
        // Á≤æÁ°ÆÂåπÈÖç
        if (this.supportedLanguages[browserLang]) {
            return browserLang;
        }

        // ËØ≠Ë®Ä‰ª£Á†ÅÂåπÈÖç
        const langCode = browserLang.split('-')[0];
        if (langCode === 'zh') {
            // ‰∏≠ÊñáÁâπÊÆäÂ§ÑÁêÜ
            if (browserLang.includes('tw') || browserLang.includes('hk') || browserLang.includes('mo')) {
                return 'zh-tw';
            }
            return 'zh-cn';
        }
        
        // ÂÖ∂‰ªñËØ≠Ë®ÄÂåπÈÖç
        const matchedLang = Object.keys(this.supportedLanguages).find(lang => 
            lang.startsWith(langCode)
        );
        if (matchedLang) {
            return matchedLang;
        }

        // 4. ËøîÂõûÈªòËÆ§ËØ≠Ë®Ä
        return this.fallbackLang;
    }

    /**
     * Âä†ËΩΩÁøªËØëÊñá‰ª∂
     */
    async loadTranslations(lang) {
        if (this.isLoading) {
            return;
        }

        this.isLoading = true;
        
        try {
            // Ê†πÊçÆÂΩìÂâçÈ°µÈù¢Ë∑ØÂæÑË∞ÉÊï¥ÁøªËØëÊñá‰ª∂Ë∑ØÂæÑ
            const currentPath = window.location.pathname;
            const basePath = currentPath.includes('/pages/') ? '../lang/' : 'lang/';
            
            const response = await fetch(`${basePath}${lang}.json`);
            if (!response.ok) {
                throw new Error(`Failed to load translations for ${lang}: ${response.status}`);
            }
            
            this.translations = await response.json();
            console.log(`üìÑ Loaded translations for: ${lang} from ${basePath}${lang}.json`);
            
        } catch (error) {
            console.error(`‚ùå Error loading translations for ${lang}:`, error);
            
            // Â¶ÇÊûú‰∏çÊòØÂêéÂ§áËØ≠Ë®ÄÔºåÂ∞ùËØïÂä†ËΩΩÂêéÂ§áËØ≠Ë®Ä
            if (lang !== this.fallbackLang) {
                console.log(`üîÑ Falling back to ${this.fallbackLang}`);
                const currentPath = window.location.pathname;
                const basePath = currentPath.includes('/pages/') ? '../lang/' : 'lang/';
                const fallbackResponse = await fetch(`${basePath}${this.fallbackLang}.json`);
                this.translations = await fallbackResponse.json();
            } else {
                throw error;
            }
        } finally {
            this.isLoading = false;
        }
    }

    /**
     * Ëé∑ÂèñÁøªËØëÊñáÊú¨
     */
    t(key, fallback = '') {
        const keys = key.split('.');
        let value = this.translations;
        
        for (const k of keys) {
            if (value && typeof value === 'object' && k in value) {
                value = value[k];
            } else {
                console.warn(`üîç Translation missing for key: ${key}`);
                return fallback || key;
            }
        }
        
        return value || fallback || key;
    }

    /**
     * Â∫îÁî®ÁøªËØëÂà∞È°µÈù¢ÂÖÉÁ¥†
     */
    applyTranslations() {
        if (!this.translations) {
            console.warn('No translations available');
            return;
        }

        console.log('Applying translations for language:', this.currentLanguage);

        // Update all elements with data-i18n attribute
        const elements = document.querySelectorAll('[data-i18n]');
        elements.forEach(element => {
            const key = element.getAttribute('data-i18n');
            const translation = this.t(key);
            
            if (translation) {
                // Handle different types of content
                if (element.tagName === 'INPUT' && element.type === 'submit') {
                    element.value = translation;
                } else if (element.hasAttribute('placeholder')) {
                    element.placeholder = translation;
                } else if (element.hasAttribute('title')) {
                    element.title = translation;
                } else {
                    element.textContent = translation;
                }
            } else {
                console.warn(`Translation not found for key: ${key}`);
            }
        });

        // Update elements with data-i18n-aria attribute
        const ariaElements = document.querySelectorAll('[data-i18n-aria]');
        ariaElements.forEach(element => {
            const key = element.getAttribute('data-i18n-aria');
            const translation = this.t(key);
            
            if (translation) {
                element.setAttribute('aria-label', translation);
            }
        });

        // Update page meta information
        this.updatePageMeta();

        console.log('Translations applied successfully');
    }

    updatePageMeta() {
        // Update page title
        const titleElement = document.querySelector('title');
        if (titleElement && this.translations.meta) {
            const pageName = this.getPageName();
            const siteTitle = this.t('meta.siteTitle') || 'IAFEI - International Association of Financial Executives Institutes';
            
            if (pageName && pageName !== 'home') {
                titleElement.textContent = `${this.t(`pages.${pageName}.title`)} - ${siteTitle}`;
            } else {
                titleElement.textContent = siteTitle;
            }
        }

        // Update meta description
        const metaDesc = document.querySelector('meta[name="description"]');
        if (metaDesc && this.translations.meta) {
            const description = this.t('meta.description');
            if (description) {
                metaDesc.setAttribute('content', description);
            }
        }

        // Update html lang attribute
        document.documentElement.setAttribute('lang', this.currentLanguage);
    }

    getPageName() {
        const path = window.location.pathname;
        if (path.includes('contact.html')) return 'contact';
        if (path.includes('about.html')) return 'about';
        if (path.includes('members.html')) return 'members';
        if (path.includes('news.html')) return 'news';
        if (path.includes('publications.html')) return 'publications';
        return 'home';
    }

    /**
     * Êõ¥Êñ∞HTMLËØ≠Ë®ÄÂ±ûÊÄß
     */
    updateHtmlLang() {
        const htmlLang = this.translations.meta?.htmlLang || this.currentLanguage;
        document.documentElement.lang = htmlLang;
        
        // Êõ¥Êñ∞ÊñáÊ°£ÊñπÂêëÔºàÂ¶ÇÊûúÈúÄË¶ÅÔºâ
        const isRTL = ['ar', 'he', 'fa'].includes(this.currentLanguage);
        document.documentElement.dir = isRTL ? 'rtl' : 'ltr';
    }

    /**
     * ÂàáÊç¢ËØ≠Ë®Ä
     */
    async switchLanguage(newLang) {
        if (!this.supportedLanguages[newLang]) {
            console.error(`‚ùå Unsupported language: ${newLang}`);
            return;
        }

        if (newLang === this.currentLanguage) {
            return;
        }

        try {
            // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
            this.showLoadingState();
            
            // Âä†ËΩΩÊñ∞ËØ≠Ë®ÄÁöÑÁøªËØë
            await this.loadTranslations(newLang);
            
            // Êõ¥Êñ∞ÂΩìÂâçËØ≠Ë®Ä
            this.currentLanguage = newLang;
            
            // ‰øùÂ≠òÂà∞localStorage
            localStorage.setItem('iafei-language', newLang);
            
            // Â∫îÁî®ÁøªËØë
            this.applyTranslations();
            
            // Êõ¥Êñ∞HTMLËØ≠Ë®ÄÂ±ûÊÄß
            this.updateHtmlLang();
            
            // Êõ¥Êñ∞ËØ≠Ë®ÄÈÄâÊã©Âô®
            this.updateLanguageSelector();
            
            // ÈöêËóèÂä†ËΩΩÁä∂ÊÄÅ
            this.hideLoadingState();
            
            // Ëß¶ÂèëËØ≠Ë®ÄÂàáÊç¢‰∫ã‰ª∂
            this.dispatchLanguageChangeEvent(newLang);
            
            console.log(`üîÑ Language switched to: ${newLang}`);
            
        } catch (error) {
            console.error(`‚ùå Error switching to language ${newLang}:`, error);
            this.hideLoadingState();
        }
    }

    /**
     * ËÆæÁΩÆËØ≠Ë®ÄÔºàswitchLanguageÁöÑÂà´ÂêçÔºâ
     */
    async setLanguage(newLang) {
        return await this.switchLanguage(newLang);
    }

    /**
     * Êõ¥Êñ∞ËØ≠Ë®ÄÈÄâÊã©Âô®ÊòæÁ§∫
     */
    updateLanguageSelector() {
        // Êõ¥Êñ∞Áé∞ÊúâÁöÑËØ≠Ë®ÄÈÄâÊã©Âô®
        this.updateLanguageSelectorDisplay();
        
        // Êõ¥Êñ∞‰º†ÁªüËØ≠Ë®ÄÈÄâÊã©Âô®ÔºàÂ¶ÇÊûúÂ≠òÂú®Ôºâ
        const currentSpan = document.querySelector('.language-current');
        if (currentSpan) {
            currentSpan.textContent = this.supportedLanguages[this.currentLanguage];
        }
        
        // Êõ¥Êñ∞ÊâÄÊúâËØ≠Ë®ÄÈÄâÈ°πÁöÑactiveÁä∂ÊÄÅ
        const allOptions = document.querySelectorAll('.language-option');
        allOptions.forEach(option => {
            const lang = option.getAttribute('data-lang');
            if (lang === this.currentLanguage) {
                option.classList.add('active');
            } else {
                option.classList.remove('active');
            }
        });
    }

    /**
     * ÂàùÂßãÂåñËØ≠Ë®ÄÈÄâÊã©Âô®
     */
    initLanguageSelector() {
        console.log('üéõÔ∏è Initializing language selector...');
        
        // ‰ΩøÁî®ÂæÆÂª∂ËøüÁ°Æ‰øùDOMÂÆåÂÖ®Âä†ËΩΩ
        setTimeout(() => {
            // Ê£ÄÊü•È°µÈù¢‰∏≠ÊòØÂê¶Â∑≤ÊúâËØ≠Ë®ÄÈÄâÊã©Âô®
            const existingButton = document.getElementById('languageBtn');
            const existingDropdown = document.getElementById('languageDropdown');
            
            console.log('üîç Language selector elements check:', {
                button: !!existingButton,
                dropdown: !!existingDropdown,
                buttonId: existingButton?.id,
                dropdownId: existingDropdown?.id
            });
            
            if (existingButton && existingDropdown) {
                console.log('‚úÖ Using existing language selector');
                // ‰ΩøÁî®Áé∞ÊúâÁöÑËØ≠Ë®ÄÈÄâÊã©Âô®
                this.bindExistingLanguageSelectorEvents();
                this.updateLanguageSelectorDisplay();
            } else {
                console.log('‚ö†Ô∏è Creating new language selector');
                // ÂàõÂª∫Êñ∞ÁöÑËØ≠Ë®ÄÈÄâÊã©Âô®ÔºàÂêëÂêéÂÖºÂÆπÔºâ
                const languageSelector = this.createLanguageSelector();
                document.body.appendChild(languageSelector);
                this.bindLanguageSelectorEvents();
            }
        }, 50);
    }

    /**
     * ÁªëÂÆöÁé∞ÊúâËØ≠Ë®ÄÈÄâÊã©Âô®ÁöÑ‰∫ã‰ª∂
     */
    bindExistingLanguageSelectorEvents() {
        console.log('üîß Starting bindExistingLanguageSelectorEvents');
        
        // ÁßªÈô§‰πãÂâçÂèØËÉΩÂ≠òÂú®ÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®
        const existingBtn = document.getElementById('languageBtn');
        const existingDropdown = document.getElementById('languageDropdown');
        
        if (!existingBtn || !existingDropdown) {
            console.error('‚ùå Language selector elements not found:', {
                btn: !!existingBtn,
                dropdown: !!existingDropdown
            });
            return;
        }
        
        // ÂÖãÈöÜÊåâÈíÆ‰ª•ÁßªÈô§ÊâÄÊúâÊóßÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®
        const newBtn = existingBtn.cloneNode(true);
        existingBtn.parentNode.replaceChild(newBtn, existingBtn);
        
        const dropdown = document.getElementById('languageDropdown'); // ÈáçÊñ∞Ëé∑Âèñ
        const options = dropdown.querySelectorAll('.language-option');
        
        console.log(`ÔøΩ Found ${options.length} language options`);
        
        // ÁÆÄÂåñÁöÑÁÇπÂáª‰∫ã‰ª∂Â§ÑÁêÜ
        newBtn.onclick = (e) => {
            console.log('üñ±Ô∏è Language button clicked!');
            e.preventDefault();
            e.stopPropagation();
            
            const isOpen = dropdown.classList.contains('open');
            dropdown.classList.toggle('open');
            
            console.log(`üîÑ Dropdown ${isOpen ? 'closed' : 'opened'}`);
        };
        
        // Â§ñÈÉ®ÁÇπÂáªÂÖ≥Èó≠
        document.onclick = (e) => {
            if (!newBtn.contains(e.target) && !dropdown.contains(e.target)) {
                dropdown.classList.remove('open');
            }
        };
        
        // ËØ≠Ë®ÄÈÄâÈ°π‰∫ã‰ª∂
        options.forEach((option, index) => {
            option.onclick = async (e) => {
                console.log(`üîÑ Language option ${index} clicked`);
                e.preventDefault();
                e.stopPropagation();
                
                const lang = option.getAttribute('data-lang');
                console.log(`üåç Switching to: ${lang}`);
                
                if (lang && lang !== this.currentLanguage) {
                    try {
                        await this.setLanguage(lang);
                        dropdown.classList.remove('open');
                        console.log(`‚úÖ Language switched successfully to: ${lang}`);
                    } catch (error) {
                        console.error('‚ùå Language switch failed:', error);
                    }
                }
            };
        });
        
        console.log('‚úÖ Language selector events bound with onclick handlers');
    }    /**
     * ÈáçÊñ∞ÁªëÂÆöËØ≠Ë®ÄÈÄâÊã©Âô®ÔºàÁî®‰∫éÈ°µÈù¢Âä®ÊÄÅÊõ¥Êñ∞ÂêéÔºâ
     */
    rebindLanguageSelector() {
        console.log('üîÑ Rebinding language selector...');
        this.bindExistingLanguageSelectorEvents();
        this.updateLanguageSelectorDisplay();
    }

    /**
     * Êõ¥Êñ∞ËØ≠Ë®ÄÈÄâÊã©Âô®ÊòæÁ§∫
     */
    updateLanguageSelectorDisplay() {
        const currentLanguageSpan = document.getElementById('currentLanguageText');
        const options = document.querySelectorAll('.language-option');
        
        if (currentLanguageSpan) {
            currentLanguageSpan.textContent = this.supportedLanguages[this.currentLanguage];
        }
        
        // Êõ¥Êñ∞ÈÄâÈ°πÁöÑactiveÁä∂ÊÄÅ
        options.forEach(option => {
            const lang = option.getAttribute('data-lang');
            if (lang === this.currentLanguage) {
                option.classList.add('active');
            } else {
                option.classList.remove('active');
            }
        });
    }

    /**
     * ÂàõÂª∫ËØ≠Ë®ÄÈÄâÊã©Âô®HTML
     */
    createLanguageSelector() {
        const selector = document.createElement('div');
        selector.className = 'language-selector';
        selector.innerHTML = `
            <button class="language-toggle" aria-label="${this.t('common.language', 'Language')}" title="${this.t('common.language', 'Language')}">
                <span class="language-icon">üåê</span>
                <span class="language-current">${this.supportedLanguages[this.currentLanguage]}</span>
                <span class="language-arrow">‚ñº</span>
            </button>
            <div class="language-dropdown">
                ${Object.entries(this.supportedLanguages).map(([code, name]) => `
                    <button class="language-option ${code === this.currentLanguage ? 'active' : ''}" 
                            data-lang="${code}" 
                            aria-label="${name}">
                        ${name}
                    </button>
                `).join('')}
            </div>
        `;
        
        return selector;
    }

    /**
     * ÁªëÂÆöËØ≠Ë®ÄÈÄâÊã©Âô®‰∫ã‰ª∂
     */
    bindLanguageSelectorEvents() {
        const toggle = document.querySelector('.language-toggle');
        const dropdown = document.querySelector('.language-dropdown');
        const options = document.querySelectorAll('.language-option');
        
        // ÂàáÊç¢‰∏ãÊãâËèúÂçï
        toggle.addEventListener('click', (e) => {
            e.stopPropagation();
            dropdown.classList.toggle('open');
            toggle.classList.toggle('active');
        });
        
        // ÈÄâÊã©ËØ≠Ë®Ä
        options.forEach(option => {
            option.addEventListener('click', (e) => {
                const newLang = e.target.getAttribute('data-lang');
                this.switchLanguage(newLang);
                dropdown.classList.remove('open');
                toggle.classList.remove('active');
            });
        });
        
        // ÁÇπÂáªÂ§ñÈÉ®ÂÖ≥Èó≠‰∏ãÊãâËèúÂçï
        document.addEventListener('click', () => {
            dropdown.classList.remove('open');
            toggle.classList.remove('active');
        });
    }

    /**
     * Êõ¥Êñ∞ËØ≠Ë®ÄÈÄâÊã©Âô®Áä∂ÊÄÅ
     */
    updateLanguageSelector() {
        const currentSpan = document.querySelector('.language-current');
        const options = document.querySelectorAll('.language-option');
        
        if (currentSpan) {
            currentSpan.textContent = this.supportedLanguages[this.currentLanguage];
        }
        
        options.forEach(option => {
            const lang = option.getAttribute('data-lang');
            option.classList.toggle('active', lang === this.currentLanguage);
        });
    }

    /**
     * ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
     */
    showLoadingState() {
        const toggle = document.querySelector('.language-toggle');
        if (toggle) {
            toggle.classList.add('loading');
            toggle.disabled = true;
        }
    }

    /**
     * ÈöêËóèÂä†ËΩΩÁä∂ÊÄÅ
     */
    hideLoadingState() {
        const toggle = document.querySelector('.language-toggle');
        if (toggle) {
            toggle.classList.remove('loading');
            toggle.disabled = false;
        }
    }

    /**
     * Ëß¶ÂèëËØ≠Ë®ÄÂàáÊç¢‰∫ã‰ª∂
     */
    dispatchLanguageChangeEvent(newLang) {
        const event = new CustomEvent('languageChanged', {
            detail: {
                oldLang: this.currentLanguage,
                newLang: newLang,
                translations: this.translations
            }
        });
        document.dispatchEvent(event);
    }

    /**
     * Ëé∑ÂèñÂΩìÂâçËØ≠Ë®Ä
     */
    getCurrentLanguage() {
        return this.currentLanguage;
    }

    /**
     * Ëé∑ÂèñÊîØÊåÅÁöÑËØ≠Ë®ÄÂàóË°®
     */
    getSupportedLanguages() {
        return this.supportedLanguages;
    }

    /**
     * Ê£ÄÊü•ÊòØÂê¶ÊîØÊåÅÊüêÁßçËØ≠Ë®Ä
     */
    isLanguageSupported(lang) {
        return !!this.supportedLanguages[lang];
    }
}

// È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÂàùÂßãÂåñ
document.addEventListener('DOMContentLoaded', async function() {
    try {
        // ÂàõÂª∫ÂÖ®Â±Äi18nÂÆû‰æã
        if (!window.i18n) {
            window.i18n = new I18nManager();
        }
        
        // ÂàùÂßãÂåñÁ≥ªÁªü
        await window.i18n.init();
        
        console.log('‚úÖ I18n system initialized successfully');
    } catch (error) {
        console.error('‚ùå Failed to initialize i18n system:', error);
    }
});

// ÂØºÂá∫ÁªôÂÖ∂‰ªñÊ®°Âùó‰ΩøÁî®
if (typeof module !== 'undefined' && module.exports) {
    module.exports = I18nManager;
}